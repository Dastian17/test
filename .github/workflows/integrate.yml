name: Ejecutar en cada push

on: push
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout del c√≥digo
      uses: actions/checkout@v4

    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Instalar dependencias
      run: npm install

    - name: Run Jest coverage for each commit
      env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Configurar el token para GitHub CLI
      run: |
          for commit in ${{ steps.commits.outputs.commit_list }}; do
            echo "Running actions for commit: $commit"
            
            # Hacer checkout de cada commit
            git checkout $commit
            
            # Instalar dependencias
            npm install
            
            # Generar el reporte de cobertura
            npx jest --coverage
            
            # Guardar el reporte de cobertura como Markdown
            COVERAGE=$(npx jest --coverage)
            
            # Hacer un comentario en el commit
            gh api repos/${{ github.repository }}/commits/$commit/comments -f body="### Jest Coverage Report for commit $commit: \n\n$COVERAGE"
          done
      shell: bash
