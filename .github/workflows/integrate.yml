name: CI

on:
  push:
    branches:
      - '**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run tests and generate coverage for each commit
        run: |
          set -e # Detener el script si hay un error
          echo "# Coverage Reports" >> $GITHUB_STEP_SUMMARY
          
          for commit in $(git rev-list ${{ github.event.before }}..${{ github.sha }}); do
            echo "## Coverage Report for commit ${commit:0:7}" >> $GITHUB_STEP_SUMMARY
            
            git checkout $commit
            npm run test -- --coverage
            
            echo "| Category | Percentage | Covered / Total |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|------------|-----------------|" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "coverage/coverage-summary.json" ]; then
              STATEMENTS=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
              BRANCHES=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)
              FUNCTIONS=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)
              LINES=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
              
              STATEMENTS_COV=$(jq -r '.total.statements.covered' coverage/coverage-summary.json)
              STATEMENTS_TOTAL=$(jq -r '.total.statements.total' coverage/coverage-summary.json)
              BRANCHES_COV=$(jq -r '.total.branches.covered' coverage/coverage-summary.json)
              BRANCHES_TOTAL=$(jq -r '.total.branches.total' coverage/coverage-summary.json)
              FUNCTIONS_COV=$(jq -r '.total.functions.covered' coverage/coverage-summary.json)
              FUNCTIONS_TOTAL=$(jq -r '.total.functions.total' coverage/coverage-summary.json)
              LINES_COV=$(jq -r '.total.lines.covered' coverage/coverage-summary.json)
              LINES_TOTAL=$(jq -r '.total.lines.total' coverage/coverage-summary.json)
              
              echo "| Statements | ${STATEMENTS}% | ${STATEMENTS_COV}/${STATEMENTS_TOTAL} |" >> $GITHUB_STEP_SUMMARY
              echo "| Branches | ${BRANCHES}% | ${BRANCHES_COV}/${BRANCHES_TOTAL} |" >> $GITHUB_STEP_SUMMARY
              echo "| Functions | ${FUNCTIONS}% | ${FUNCTIONS_COV}/${FUNCTIONS_TOTAL} |" >> $GITHUB_STEP_SUMMARY
              echo "| Lines | ${LINES}% | ${LINES_COV}/${LINES_TOTAL} |" >> $GITHUB_STEP_SUMMARY
            else
              echo "No coverage data found for this commit" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "coverage/lcov.info" ]; then
              mv coverage/lcov.info coverage/lcov-$commit.info
            fi
          done
      
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: coverage/
