name: CI Workflow for Each Commit

on:
  push:
    branches:
      - '**'

jobs:
  run-for-each-commit:
    runs-on: ubuntu-latest

    steps:
      # Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Retrieve the list of commits for the push event
      - name: Get commits from push
        id: commits
        run: |
          echo "Commits in push:"
          echo "${{ toJson(github.event.commits) }}"
          
          # Export the commit list as an output for the job
          echo "::set-output name=commit-list::$(echo '${{ toJson(github.event.commits) }}' | jq -r '.[].id')"

      # Iterate through commits and run build/test for each one
      - name: Run actions for each commit
        run: |
          for commit in $(jq -r '.[].id' <<< "${{ toJson(github.event.commits) }}"); do
            echo "Running actions for commit: $commit"
            git checkout $commit
            
            # Run your build and test for each commit
            echo "Running build for commit $commit"
            npm install
            npm run build
            npm test
          done
        shell: bash

      # Post success comment for each commit
      - name: Comment on each commit
        uses: actions/github-script@v6
        with:
          script: |
            const commits = ${{ toJson(github.event.commits) }};
            for (const commit of commits) {
              github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commit.id,
                body: `âœ… CI passed successfully for commit: ${commit.id}`
              });
            }
