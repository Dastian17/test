name: CI Workflow for Each Commit with Jest Coverage

on:
  push:
    branches:
      - "**"

permissions:
  contents: write # Permission to write to the repo (necessary for commenting)

jobs:
  run-for-each-commit:
    runs-on: ubuntu-latest

    steps:
      # Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Ensure all commits are available

      # Get commits from the push event and store them as output
      - name: Get commits from push
        id: commits
        run: |
          commit_list=$(jq -r '.[] | .id' <<< '${{ toJson(github.event.commits) }}')
          echo "::set-output name=commit_list::${commit_list}"

      # Install GitHub CLI
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Run Jest coverage for each commit
      - name: Run Jest coverage for each commit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Configure token for GitHub CLI
        run: |
          commit_list="${{ steps.commits.outputs.commit_list }}"
           for commit in $(git rev-list ${{ github.event.before}}..${{ github.sha}}); do
              git checkout $commit
              echo "run test"
               # Install dependencies
              npm install
            
              # Parse the coverage summary JSON
              COVERAGE_SUMMARY=$(cat coverage/coverage-summary.json)

              STATEMENTS=$(echo "$COVERAGE_SUMMARY" | jq '.total.statements.pct')
              BRANCHES=$(echo "$COVERAGE_SUMMARY" | jq '.total.branches.pct')
              FUNCTIONS=$(echo "$COVERAGE_SUMMARY" | jq '.total.functions.pct')
              LINES=$(echo "$COVERAGE_SUMMARY" | jq '.total.lines.pct')

              TOTAL_STATEMENTS=$(echo "$COVERAGE_SUMMARY" | jq '.total.statements.total')
              COVERED_STATEMENTS=$(echo "$COVERAGE_SUMMARY" | jq '.total.statements.covered')

              TOTAL_BRANCHES=$(echo "$COVERAGE_SUMMARY" | jq '.total.branches.total')
              COVERED_BRANCHES=$(echo "$COVERAGE_SUMMARY" | jq '.total.branches.covered')

              TOTAL_FUNCTIONS=$(echo "$COVERAGE_SUMMARY" | jq '.total.functions.total')
              COVERED_FUNCTIONS=$(echo "$COVERAGE_SUMMARY" | jq '.total.functions.covered')

              TOTAL_LINES=$(echo "$COVERAGE_SUMMARY" | jq '.total.lines.total')
              COVERED_LINES=$(echo "$COVERAGE_SUMMARY" | jq '.total.lines.covered')

              # Format the report in Markdown table
              FORMATTED_COVERAGE="### Coverage report for commit $commit\n\n"
              FORMATTED_COVERAGE+="| St. ‚ùî | Category   | Percentage | Covered / Total |\n"
              FORMATTED_COVERAGE+="|--------|------------|------------|----------------|\n"
              FORMATTED_COVERAGE+="| üü¢      | Statements | $STATEMENTS%       | $COVERED_STATEMENTS/$TOTAL_STATEMENTS            |\n"
              FORMATTED_COVERAGE+="| üü¢      | Branches   | $BRANCHES%       | $COVERED_BRANCHES/$TOTAL_BRANCHES            |\n"
              FORMATTED_COVERAGE+="| üü¢      | Functions  | $FUNCTIONS%       | $COVERED_FUNCTIONS/$TOTAL_FUNCTIONS            |\n"
              FORMATTED_COVERAGE+="| üü¢      | Lines      | $LINES%       | $COVERED_LINES/$TOTAL_LINES            |\n"

              # Comment on the commit with formatted coverage
              gh api repos/${{ github.repository }}/commits/$commit/comments -f body="$FORMATTED_COVERAGE"
          done
        shell: bash
     #####
      #- name: Run E2E Tests
      #  uses: cypress-io/github-action@v4
      #  with:
      #    start: npm start
      #    wait-on: "http://localhost:1234"
      #####
      #- name: Build for deploy
      #  run: npm run build
      #- name: Deploy to GitHub Pages
      #  if: success()
      #  uses: crazy-max/ghaction-github-pages@v2
      #  with:
      #    target_branch: gh-pages
      #    build_dir: dist
      #  env:
      #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}