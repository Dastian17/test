name: javascript-CI

on:
  push:
    branches: [main]

jobs:
  ci_to_main:
    runs-on: ubuntu-latest
    strategy:
      # Matriz que iterará sobre los commits
      # Usamos un paso inicial para obtener los commits y luego pasarlos a la matriz
      matrix:
        commit: []

    steps:
      - uses: actions/checkout@v4
      
      # Obtener todos los commits incluidos en el push
      - name: Get list of commits
        id: commits
        run: |
          COMMITS=$(git log --oneline HEAD^..HEAD | awk '{print $1}')
          echo "::set-output name=commit_list::${COMMITS}"

      # Modificar la matriz para iterar sobre cada commit
      - name: Set commit matrix
        run: echo "${{ steps.commits.outputs.commit_list }}" | tr ' ' '\n'
        id: set-matrix
        continue-on-error: false
        outputs:
          matrix_commit: ${{ steps.commits.outputs.commit_list }}

      # Hacer checkout del commit específico en cada iteración
      - name: Checkout specific commit
        run: git checkout ${{ matrix.commit }}

      - name: Set up node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run Unit Tests for ${{ matrix.commit }}
        run: npm run test-once

      - name: Jest coverage report
        uses: ArtiomTr/jest-coverage-report-action@v2.2.6
        id: coverage
        with:
          output: report-markdown, comment

      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: ${{ steps.coverage.outputs.report }}
